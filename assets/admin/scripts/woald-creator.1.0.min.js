(function(l){var n=n||{};n.createDelegate=function(f,d){return function(){return d.apply(f,arguments)}};n.createCallback=function(f,d,j){return function(){var a=arguments.length;if(a>0){for(var c=[],b=0;b<a;b++)c[b]=arguments[b];c[a]=j;return f.apply(d||this,c)}return f.call(d||this,j)}};l.Woald||(l.Woald=n)})(window,document);
(function(l,n,f,d,j){d.creator=function(a){this.options=a||{};this.searchFields=[];this.zoom=a.zoom?a.zoom:2;this.previewImageUrl=a.previewImageUrl;this.selectedMapStyle=a.selectedMapStyle;this.loadingNearbyMesssage="Loading nearby locations";this.loadingMapTilesMessage="Loading Map Tiles";this.loadingGeocodeMessage="Requesting geocode data";this.addressContextMenuLabel="Address";this.departureContextMenuLabel="Departure";this.destinationContextMenuLabel="Destination";this.waypointContextMenuLabel=
"Waypoint";this.newPlaceContextMenuLabel="Add new place";this.resizeDelegate=d.createDelegate(this,this.resize);this.unloadDelegate=d.createDelegate(this,this.unloadHandler);f.maps.event.addDomListener(l,"resize",this.resizeDelegate);f.maps.event.addDomListener(l,"unload",this.unloadDelegate);this.initialize()};d.creator.placeType={departure:0,destination:1};d.creator.contextMenu={initaialLocation:0,departure:1,destination:2,waypoint:3,addNewPlace:4};d.creator.prototype.progressBarShow=function(a){a&&
this.modalProgressReport.html(a);this.modalProgress.dialog("open").is(":visible")};d.creator.prototype.progressBarHide=function(){this.modalProgress.dialog("close").is(":visible")};d.creator.prototype.initialize=function(){var a=this.options,c=a.lat?a.lat:0,b=a.lng?a.lng:0,e=c&&b?13:this.zoom;this.location=new f.maps.LatLng(c,b);this.$root=j(a.id);this.$mapElement=this.$root.find(".woald-map-canvas");if(this.$mapElement.length>0){this.map=new f.maps.Map(this.$mapElement[0],{center:this.location,zoom:e,
mapTypeId:f.maps.MapTypeId.ROADMAP,clickableIcons:false});this.mapContextMenuDelegate=d.createDelegate(this,this.mapContextMenuHandler);f.maps.event.addListener(this.map,"rightclick",this.mapContextMenuDelegate);this.contextMenuExitDelegate=d.createDelegate(this,this.contextMenuExitHandler);f.maps.event.addListener(this.map,"click",this.contextMenuExitDelegate);j(l.document).on("click",this.contextMenuExitDelegate);this.tilesLoadedDelegate=d.createDelegate(this,this.tilesLoadedHandler);f.maps.event.addDomListener(this.map,
"tilesloaded",this.tilesLoadedDelegate)}this.initControls(a);this.browserSupportFlag=new Boolean(false);if(this.map){this.progressBarShow(this.loadingMapTilesMessage);this.autocompleteInit();this.$mapDiv=j(this.map.getDiv());this.$mapDiv.append(this.getContextMenu());this.$contextMenu=this.$root.find(".woald-creator-contextmenu");this.$contextMenu.menu();this.contextMenuItemClickDelegate=d.createDelegate(this,this.contextMenuItemClickHandler);this.$contextMenu.find("a").on("click",this.contextMenuItemClickDelegate)}this.initializeWaypoints()};
d.creator.prototype.initControls=function(a){var c=this;this.$mapWidth=this.$root.find('input[name="mapWidth"]');this.$mapHeight=this.$root.find('input[name="mapHeight"]');this.$mapWidthUnit=this.$root.find('select[name="mapWidthUnit"]');this.$mapHeightUnit=this.$root.find('select[name="mapHeightUnit"]');this.$regionLat=this.$root.find("#regionLat");this.$regionLng=this.$root.find("#regionLng");this.$regionAddress=this.$root.find('input[name="regionAddress"]');this.$regionLatLng=this.$root.find("#regionLatLng");
this.$restrictRadius=this.$root.find("#restrictRadius");this.$regionMarkerIconUrl=this.$root.find('input[name="regionMarkerIconUrl"]');this.$regionMarkerIconHeight=this.$root.find('input[name="regionMarkerIconHeight"]');this.$regionMarkerIconWidth=this.$root.find('input[name="regionMarkerIconWidth"]');this.$regionInfoWindowIcon=this.$root.find('input[name="regionInfoWindowIcon"]');this.$regionInfoWindowDescription=this.$root.find('textarea[name="regionInfoWindowDescription"]');this.$regionShowMarker=
this.$root.find('input[name="regionShowMarker"]');this.$fromLat=this.$root.find('input[name="fromLat"]');this.$fromLng=this.$root.find('input[name="fromLng"]');this.$contextMenuType=this.$root.find('input[name="contextMenuType"]');this.$nearbyDeparturePlaces=this.$root.find('button[name="nearbyDeparturePlaces"]');this.$departurePlacesList=this.$root.find('select[name="departurePlacesList"]');this.$departurePlacesPreview=this.$root.find(".departure-places-preview");this.$addDeparture=this.$root.find('button[name="addDeparture"]');
this.$clearDepartureItems=this.$root.find('button[name="clearDepartureItems"]');this.$toAddress=this.$root.find('input[name="toAddress"]');this.$toLatLng=this.$root.find("#toLatLng");this.$toInfoWindowIcon=this.$root.find('input[name="toInfoWindowIcon"]');this.$toInfoWindowDescription=this.$root.find('textarea[name="toInfoWindowDescription"]');this.$destinationListAttributes=this.$root.find("#destinationListAttributes");this.$nearbyDestinationPlaces=this.$root.find('button[name="nearbyDestinationPlaces"]');
this.$destinationPlacesList=this.$root.find('select[name="destinationPlacesList"]');this.$destinationLocationsGroup=this.$root.find("#destinationLocationsGroup");this.$addDestination=this.$root.find('button[name="addDestination"]');this.$destinationPlacesPreview=this.$root.find(".destination-places-preview");this.$fromPlacesPreload=this.$root.find('input[name="fromPlacesPreload"]');this.$toPlacesPreload=this.$root.find('input[name="toPlacesPreload"]');this.$enableContextMenu=this.$root.find('input[name="enableContextMenu"]');
this.$optimizeWayPoints=this.$root.find('input[name="optimizeWayPoints"]');this.$draggableMarker=this.$root.find('input[name="draggableMarker"]');this.$enableDirection=this.$root.find('input[name="enableDirection"]');this.$enableDirectionButton=this.$root.find('input[name="enableDirectionButton"]');this.$placeModal=j("#placeModal");this.$placeType=this.$placeModal.find('input[name="placeType"]');this.$placeId=this.$placeModal.find('input[name="placeId"]');this.$placeLat=this.$placeModal.find('input[name="lat"]');
this.$placeLng=this.$placeModal.find('input[name="lng"]');this.$placeName=this.$placeModal.find('input[name="name"]');this.$placeCost=this.$placeModal.find('input[name="cost"]');this.$placeIcon=this.$placeModal.find('input[name="markerIcon"]');this.$placeIconWidth=this.$placeModal.find('input[name="markerIconWidth"]');this.$placeIconHeight=this.$placeModal.find('input[name="markerIconHeight"]');this.$placeInfoWindowIcon=this.$placeModal.find('input[name="infoWindowIcon"]');this.$placeInfoWindowDescription=
this.$placeModal.find('textarea[name="infoWindowDescription"]');this.$styledMaps=this.$root.find('select[name="styledMaps"]');this.$backgroundGradient=this.$root.find('select[name="backgroundGradient"]');this.$highway=this.$root.find('input[name="highway"]');this.$toll=this.$root.find('input[name="toll"]');this.$traffic=this.$root.find('input[name="traffic"]');this.$zoom=this.$root.find('input[name="zoom"]');this.$panToZoom=this.$root.find('input[name="panToZoom"]');this.$formCollapsed=this.$root.find('input[name="formCollapsed"]');
this.$showTotalDistance=this.$root.find('input[name="showTotalDistance"]');this.$costPerUnit=this.$root.find('input[name="costPerUnit"]');this.$costUnitType=this.$root.find('select[name="costUnitType"]');this.$currencySymbol=this.$root.find('input[name="currencySymbol"]');this.$currencySymbolPosition=this.$root.find('select[name="currencySymbolPosition"]');this.$currency=this.$root.find('input[name="currency"]');this.$decimalPoint=this.$root.find('input[name="decimalPoint"]');this.$thousandsSep=this.$root.find('input[name="thousandsSep"]');
this.$enableRegionPhotos=this.$root.find('input[name="enableRegionPhotos"]');this.$photoMaxWidth=this.$root.find('input[name="photoMaxWidth"]');this.$photoMaxHeight=this.$root.find('input[name="photoMaxHeight"]');this.$photoBackgroundSize=this.$root.find('input[name="photoBackgroundSize"]');this.$photoBackgroundRepeat=this.$root.find('select[name="photoBackgroundRepeat"]');this.$photoNearbySearchKeyword=this.$root.find('input[name="photoNearbySearchKeyword"]');this.$photoNearbySearchTypes=this.$root.find('select[name="photoNearbySearchTypes"]');
this.$photoDelay=this.$root.find('input[name="photoDelay"]');this.$paramsBlock=this.$root.find(".params-block");this.$searchButton=this.$root.find('button[name="search"]');this.$myPosButton=this.$root.find('button[name="mypos"]');this.$preview=this.$root.find("#preview");this.$waypointFieldNames=this.$root.find('input[name="waypointFieldNames"]');this.$waypoints=this.$root.find(".woald-waypoints-placeholder tbody");this.$waypointsAddButton=this.$root.find('button[name="addwaypoint"]');this.$tabs=
this.$root.find('.woald-tab a[data-toggle="tab"]');this.$enableDistanceMeasurement=this.$root.find('input[name="enableDistanceMeasurement"]');this.$enableHighway=this.$root.find('input[name="enableHighway"]');this.$enableTolls=this.$root.find('input[name="enableTolls"]');this.$enableTraffic=this.$root.find('input[name="enableTraffic"]');this.$enableCollapseButton=this.$root.find('input[name="enableCollapseButton"]');this.$enableWaypointButton=this.$root.find('input[name="enableWaypointButton"]');
this.$enableDestinationField=this.$root.find('input[name="enableDestinationField"]');this.$enableDepartureField=this.$root.find('input[name="enableDepartureField"]');this.$enableSubmitButton=this.$root.find('input[name="enableSubmitButton"]');this.$enableScrollWheel=this.$root.find('input[name="enableScrollWheel"]');this.$submitButtonText=this.$root.find('input[name="submitButtonText"]');this.$driving=this.$root.find('input[name="driving"]');this.$labelDriving=this.$root.find('input[name="labelDriving"]');
this.$walking=this.$root.find('input[name="walking"]');this.$labelWalking=this.$root.find('input[name="labelWalking"]');this.$bicycling=this.$root.find('input[name="bicycling"]');this.$labelBicycling=this.$root.find('input[name="labelBicycling"]');this.$transit=this.$root.find('input[name="transit"]');this.$labelTransit=this.$root.find('input[name="labeltransit"]');this.$defaultTravelMode=this.$root.find('select[name="defaultTravelMode"]');this.$fromContextMenuLabel=this.$root.find('input[name="fromContextMenuLabel"]');
this.$toContextMenuLabel=this.$root.find('input[name="toContextMenuLabel"]');this.$waypointContextMenuLabel=this.$root.find('input[name="waypointContextMenuLabel"]');this.$directionEmptyError=this.$root.find('input[name="directionEmptyError"]');this.$directionDataUnavailable=this.$root.find('input[name="directionDataUnavailable"]');this.$queryLimitTimeout=this.$root.find('input[name="queryLimitTimeout"]');this.posErrorMsg=a.posErrorMsg?a.posErrorMsg:"An error occurred while trying to determine your position.";
this.geolocationErrorMsg=a.geolocationErrorMsg?a.geolocationErrorMsg:"Your browser does not support geolocation. We have placed you somewhere.";this.directionEmptyError=a.directionEmptyError?a.directionEmptyError:"<strong>Heads up!</strong> Provide both a departure and arrival address above to view direction data.";this.directionDataUnavailable=a.directionDataUnavailable?a.directionDataUnavailable:"<strong>Heads up!</strong> Direction data unavailable. Probably chosen departure and destination are not connected by roads, too far perhaps?.";
this.$waypointMarkerIconUrl=this.$root.find('input[name="waypointMarkerIconUrl"]');this.$waypointMarkerIconHeight=this.$root.find('input[name="waypointMarkerIconHeight"]');this.$waypointMarkerIconWidth=this.$root.find('input[name="waypointMarkerIconWidth"]');this.$showDirectionStepsInline=this.$root.find('input[name="showDirectionStepsInline"]');this.$contentBeforeSelector=this.$root.find('input[name="contentBeforeSelector"]');this.$contentAfterSelector=this.$root.find('input[name="contentAfterSelector"]');
this.$contentEndSelector=this.$root.find('input[name="contentEndSelector"]');this.$destinationRequired=this.$root.find('input[name="destinationRequired"]');this.$departureRequired=this.$root.find('input[name="departureRequired"]');this.$validators=this.$root.find(".woald_parsley_validated");this.$placesValidators=this.$root.find('input[data-parsley-group="block_place"]');this.modalProgress=j("#progressModal").dialog({autoOpen:false,height:"auto",width:"auto",modal:true,dialogClass:"calendarista-dialog"});
this.modalProgressBar=this.modalProgress.find("#progress-bar");this.modalProgressBar.progressbar({value:false});this.modalProgressReport=this.modalProgress.find(".progress-report");if(this.$waypointsAddButton.length>0){this.waypointsAddDelegate=d.createDelegate(this,this.waypointsAddHandler);this.$waypointsAddButton.on("click",this.waypointsAddDelegate)}if(this.$searchButton.length>0){this.searchClickDelegate=d.createDelegate(this,this.searchClickHandler);this.$searchButton.on("click",this.searchClickDelegate)}if(this.$myPosButton.length>
0){this.myPosClickDelegate=d.createDelegate(this,this.myPosClickHandler);f.maps.event.addDomListener(this.$myPosButton[0],"click",this.myPosClickDelegate)}this.fillStyledMaps();this.$styledMaps.on("change",function(){c.setMapStyle()});this.map&&this.$styledMaps.length>0&&this.$styledMaps[0].selectedIndex>0&&this.setMapStyle();this.autocompleteOnPasteDelegate=d.createDelegate(this,this.autocompleteOnPasteHandler);this.$regionLatLng.on("paste",this.autocompleteOnPasteDelegate);this.tabToggleDelegate=
d.createDelegate(this,this.tabToggleHandler);this.$tabs.on("shown.bs.tab",this.tabToggleDelegate);this.tabClickDelegate=d.createDelegate(this,this.tabClickHandler);this.$tabs.on("click",this.tabClickDelegate);this.addDestinationClickDelegate=d.createDelegate(this,this.addDestinationClickHandler);this.addDepartureClickDelegate=d.createDelegate(this,this.addDepartureClickHandler);this.$addDeparture.on("click",this.addDepartureClickDelegate);this.$addDestination.on("click",this.addDestinationClickDelegate);
this.$formPlaceModal=this.$root.find("#formPlaceModal");this.$placeModalDialog=this.$placeModal.dialog({autoOpen:false,height:"350",width:"auto",modal:true,dialogClass:"calendarista-dialog",buttons:[{"class":"block_place",text:"Add",click:function(){c.$formPlaceModal[0].submit()}},{text:"Cancel",click:function(){c.$placeModalDialog.dialog("close")}}]});this.addBoundryByRadiusDelegate=d.createDelegate(this,this.addBoundryByRadius);this.$restrictRadius.on("change",this.addBoundryByRadiusDelegate)};
d.creator.prototype.addBoundryByRadius=function(){var a=this.$restrictRadius.length>0?parseInt(this.$restrictRadius.val(),10):null;if(a&&this.currentLocationMarker){this.circle&&this.circle.setMap(null);this.circle=new f.maps.Circle({map:this.map,radius:a,fillColor:"#AA0000"});this.circle.bindTo("center",this.currentLocationMarker,"position");this.map.fitBounds(this.circle.getBounds())}};d.creator.prototype.setMapStyle=function(){var a=this.$styledMaps.val(),c=null,b=this.$styledMaps[0].options[this.$styledMaps[0].selectedIndex].text;
if(a)c=l.JSON.parse(a);this.map.mapTypes.set("map_style",new f.maps.StyledMapType(c,{name:b}));this.map.setMapTypeId("map_style")};d.creator.prototype.fillStyledMaps=function(){var a,c,b=false,e;for(c in d.creator.styles){a=d.creator.styles[c];e=l.JSON.stringify(a.value);if(e.indexOf(this.selectedMapStyle)!==-1)b=true;this.$styledMaps.append(new Option(a.name,e,false,b));b=false}};d.creator.prototype.contextMenuItemClickHandler=function(a,c){var b=j(a.currentTarget),e=b.parent().parent(),g=parseInt(b.attr("data-woald-menu"),
10);this.$root.find('input[data-woald-waypoint-id="'+parseInt(b.attr("data-woald-waypoint-id"),10)+'"]');b=parseFloat(e.attr("data-woald-lat"));e=parseFloat(e.attr("data-woald-lng"));e=[b,e].join(",");this.resetMarkers();switch(g){case 0:this.geocodeRequest(e,{infoWindow:this.infoWindowRegion,marker:this.regionMarker,elem:this.$regionLatLng});break;case 3:this.geocodeRequest(e,c);break;case 4:this.resetPlaceFields();(function(h,k,i,m){l.setTimeout(function(){m.geocodeRequest(h,{infoWindow:k,marker:i,
newPlace:true})},200)})(e,this.infoWindowPlaceItem,this.placeItemMarker,this)}this.contextMenuExitHandler();return false};d.creator.prototype.contextMenuExitHandler=function(){this.$contextMenu.hasClass("hide")||this.$contextMenu.addClass("hide")};d.creator.prototype.mapContextMenuHandler=function(a){a.stop();a.latLng.lat();a.latLng.lng();var c=this.fromLatLngToPoint(a.latLng),b=c.x,e=c.y,g=this.$mapDiv.width(),h=this.$mapDiv.height(),k,i,m=this;if(this.$contextMenu.find("li").length===0)return false;
l.setTimeout(function(){m.$contextMenu.removeClass("hide");k=m.$contextMenu.width();i=m.$contextMenu.height();if(g-b<k)b-=k;if(h-e<i)e-=i;m.$contextMenu.attr("data-woald-lat",a.latLng.lat()).attr("data-woald-lng",a.latLng.lng());m.$contextMenu.css({left:b+"px",top:e+"px"})},10);return false};d.creator.prototype.fromLatLngToPoint=function(a){var c=Math.pow(2,this.map.getZoom()),b=new f.maps.LatLng(this.map.getBounds().getNorthEast().lat(),this.map.getBounds().getSouthWest().lng());b=this.map.getProjection().fromLatLngToPoint(b);
a=this.map.getProjection().fromLatLngToPoint(a);return new f.maps.Point(Math.floor((a.x-b.x)*c),Math.floor((a.y-b.y)*c))};d.creator.prototype.addDestinationClickHandler=function(){this.$placeType.val(d.creator.placeType.destination);this.resetPlaceFields();this.$placeModalDialog.dialog("open")};d.creator.prototype.addDepartureClickHandler=function(){this.$placeType.val(d.creator.placeType.departure);this.resetPlaceFields();this.$placeModalDialog.dialog("open")};d.creator.prototype.resetPlaceFields=
function(){this.$placeId.val("");this.$placeLat.val("");this.$placeLng.val("");this.$placeName.val("");this.$placeCost.val("");this.$placeIcon.val("");this.$placeIconWidth.val("");this.$placeIconHeight.val("")};d.creator.prototype.autocompleteOnPasteHandler=function(a){(function(c){return setTimeout(function(){var b=c.val();c.blur();c.val(b);return c.focus()},1)})(j(a.currentTarget))};d.creator.prototype.tabClickHandler=function(a){a=j(a.target);if(!this.isValid())return false;a.tab("show")};d.creator.prototype.tabToggleHandler=
function(a){this.gen();switch(a.target.hash){case "#preview":this.gmaps&&this.gmaps.unload();this.gmaps=new d.gmaps(this.args);break;default:l.console.log("activating creator")}};d.creator.prototype.isValid=function(a){var c=true;a=a||this.$validators;a.each(function(){var b=j(this);if(!b.is(":visible")||b.is(":disabled")||b.attr("data-parsley-excluded"))return true;b=b.parsley().validate(true);if(b!==null&&typeof b==="object"&&b.length>0)c=false});return c};d.creator.prototype.searchClickHandler=
function(){this.search()};d.creator.prototype.search=function(){var a=j.trim(this.$regionLatLng.val());this.searchFields.length=0;a&&this.searchFields.push([a,{infoWindow:this.infoWindowRegion,marker:this.regionMarker,elem:this.$regionLatLng}]);if(this.searchFields.length>0){a=this.searchFields.splice(this.searchFields.length-1,1)[0];this.geocodeRequest(a[0],a[1])}};d.creator.prototype.myPosClickHandler=function(){this.$regionLatLng.val("");this.geoLocate({infoWindow:this.infoWindowRegion,marker:this.regionMarker,
elem:this.$regionLatLng})};d.creator.prototype.tilesLoadedHandler=function(){this.progressBarHide();this.mapLoaded&&this.mapLoaded(this.map)};d.creator.prototype.getLocality=function(a){var c,b,e="";for(c=0;c<a.address_components.length;c++){b=a.address_components[c];if(b.types&&b.types[0]==="route")e=b.long_name;if(b.types&&b.types[0]==="locality")return b.long_name}return e};d.creator.prototype.getFriendlyName=function(a){var c,b,e,g=[a.address_components[0]&&a.address_components[0].short_name||
"",a.address_components[1]&&a.address_components[1].short_name||""].join(" ");if(g)g+=", ";g+=a.address_components[2]&&a.address_components[2].short_name||"";for(c=0;c<a.address_components.length;c++){e=a.address_components[c];if(e.types)for(b=0;b<e.types.length;b++)if(e.types[b]==="administrative_area_level_2"){g+=g?", "+e.short_name:e.short_name;return g}}return g};d.creator.prototype.autocompleteInit=function(){var a,c;if(!this.autocompletes)this.autocompletes=[];if(!this.infoWindows)this.infoWindows=
[];if(!this.markers)this.markers=[];if(this.$regionLatLng.length>0){c=new f.maps.places.Autocomplete(this.$regionLatLng[0]);c.bindTo("bounds",this.map);c.setTypes(["geocode"]);this.autocompletes.push(c);this.infoWindowRegion=new f.maps.InfoWindow;this.infoWindows.push(this.infoWindowRegion);this.regionMarker=new f.maps.Marker({map:this.map,anchorPoint:new f.maps.Point(0,-29)});this.markers.push(this.regionMarker);a=d.createCallback(this.toggleInfoWindowHandler,this,{infoWindow:this.infoWindowRegion,
marker:this.regionMarker});f.maps.event.addListener(this.regionMarker,"click",a);a=d.createCallback(this.autocomplete,this,[c,this.infoWindowRegion,this.regionMarker,this.$regionLatLng]);f.maps.event.addListener(c,"place_changed",a);this.$regionLatLng.val()&&this.geocodeRequest(this.$regionLatLng.val(),{infoWindow:this.infoWindowRegion,marker:this.regionMarker,elem:this.$regionLatLng})}this.infoWindowPlaceItem=new f.maps.InfoWindow;this.infoWindows.push(this.infoWindowPlaceItem);this.placeItemMarker=
new f.maps.Marker({map:this.map,anchorPoint:new f.maps.Point(0,-29)});this.markers.push(this.placeItemMarker);c=d.createCallback(this.toggleInfoWindowHandler,this,{infoWindow:this.infoWindowPlaceItem,marker:this.placeItemMarker});f.maps.event.addListener(this.placeItemMarker,"click",c)};d.creator.prototype.autocomplete=function(a){var c=a[1],b=a[2],e=a[3];this.locate(a[0].getPlace(),c,b,e,null)};d.creator.prototype.resetMarkers=function(){for(var a in this.markers)this.markers[a].setVisible(false);
for(a in this.infoWindows)this.infoWindows[a].close();for(a in this.infoWindowsWaypoint)this.infoWindowsWaypoint[a].obj.close();for(a in this.markersWaypoint)this.markersWaypoint[a].obj.setVisible(false)};d.creator.prototype.fitMarkers=function(){var a=new f.maps.LatLngBounds,c,b=[],e,g=13,h=0;b=b.concat(this.markers);if(this.markersWaypoint)b=b.concat(this.markersWaypoint);for(c=0;c<b.length;c++){e=b[c];if(e.obj)e=e.obj;if(e=e.getPosition()){++h;a.extend(e)}}this.map.fitBounds(a);if(h>1)g=this.getZoomLevel(a,
{height:this.$mapElement.height(),width:this.$mapElement.width()});this.map.setZoom(g)};d.creator.prototype.getZoomLevel=function(a,c){var b={height:256,width:256},e=a.getNorthEast(),g=a.getSouthWest(),h=(this.latRad(e.lat())-this.latRad(g.lat()))/Math.PI;e=e.lng()-g.lng();e=(e<0?e+360:e)/360;h=this.zoomLevel(c.height,b.height,h);b=this.zoomLevel(c.width,b.width,e);return Math.min(h,b,21)};d.creator.prototype.latRad=function(a){a=Math.sin(a*Math.PI/180);return Math.max(Math.min(Math.log((1+a)/(1-
a))/2,Math.PI),-Math.PI)/2};d.creator.prototype.zoomLevel=function(a,c,b){return Math.floor(Math.log(a/c/b)/Math.LN2)};d.creator.prototype.locate=function(a,c,b,e,g){var h="",k,i=a.geometry.location,m;c.close();b.setVisible(false);this.currentLocationMarker=b;if(a.geometry){if(a.geometry.viewport)this.map.fitBounds(a.geometry.viewport);else{this.map.setCenter(i);this.map.setZoom(13)}if(a.formatted_address)h=a.formatted_address;else if(a.address_components)h=[a.address_components[0]&&a.address_components[0].short_name||
"",a.address_components[1]&&a.address_components[1].short_name||"",a.address_components[2]&&a.address_components[2].short_name||""].join(" ");k=a.name?a.name:this.getLocality(a);m=this.getFriendlyName(a);i={address:h,lat:i.lat(),lng:i.lng(),markerIcon:a.icon};if(k)i.name=k;h="<div><strong>"+k+"</strong><br>"+h+"</div>";if(e){if(e.prop("id")==="regionLatLng"){this.$regionLatLng.val(i.address);this.$regionAddress.val(i.address);this.$regionLat.val(i.lat);this.$regionLng.val(i.lng);this.$regionInfoWindowDescription.val(h)}if(e.prop("name")===
"waypoint"){e.val(i.address);j('input[name="'+e.attr("data-woald-address")+'"]').val(i.address);j('input[name="'+e.attr("data-woald-lat")+'"]').val(i.lat);j('input[name="'+e.attr("data-woald-lng")+'"]').val(i.lng)}}b.setPosition(a.geometry.location);b.setVisible(true);c.setContent(h);c.open(this.map,b);this.fitMarkers();if(g){this.$placeLat.val(i.lat);this.$placeLng.val(i.lng);this.$placeName.val(m);this.$placeInfoWindowDescription.val(h);this.$placeModalDialog.dialog("open")}this.addBoundryByRadius()}};
d.creator.prototype.resize=function(){if(this.map&&this.map.getCenter){var a=this.map.getCenter();f.maps.event.trigger(this.map,"resize");this.map.setCenter(a)}};d.creator.prototype.isOpen=function(a){a=a?a.getMap():null;return a!==null&&typeof a!=="undefined"};d.creator.prototype.toggleInfoWindowHandler=function(a,c){this.toggleInfoWindow(c)};d.creator.prototype.toggleInfoWindow=function(a){var c=a.infoWindow;a=a.marker;this.isOpen(c)?c.close(this.map,a):c.open(this.map,a)};d.creator.prototype.geoLocate=
function(a){if(navigator.geolocation){this.browserSupportFlag=true;this.getCurrentPositionDelegate=d.createCallback(this.getCurrentPosition,this,a);this.handleNoGeoLocationDelegate=d.createDelegate(this,this.handleNoGeoLocation);navigator.geolocation.getCurrentPosition(this.getCurrentPositionDelegate,this.handleNoGeoLocationDelegate,null)}else{this.browserSupportFlag=false;this.handleNoGeolocation()}};d.creator.prototype.geocodeRequest=function(a,c){var b=a.split(","),e;if(b.length>1){e=parseFloat(b[0]);
b=parseFloat(b[1]);if(!isNaN(e)&&!isNaN(b)){e=new f.maps.LatLng(e,b);this.geocode({latLng:e},c);return}}this.geocode({address:a},c)};d.creator.prototype.getCurrentPosition=function(a,c){this.geocode({latLng:new f.maps.LatLng(a.coords.latitude,a.coords.longitude)},c)};d.creator.prototype.geocode=function(a,c){var b;if(!this.geocoder)this.geocoder=new f.maps.Geocoder;this.progressBarShow(this.loadingGeocodeMessage);b=d.createCallback(this.reverseGeocodeHandler,this,c);this.geocoder.geocode(a,b)};d.creator.prototype.reverseGeocodeHandler=
function(a,c,b){var e=b.elem,g=b.newPlace;this.progressBarHide();c===f.maps.GeocoderStatus.OK&&this.locate(a[0],b.infoWindow,b.marker,e,g);if(this.searchFields.length>0){a=this.searchFields.splice(this.searchFields.length-1,1)[0];this.geocodeRequest(a[0],a[1])}};d.creator.prototype.handleNoGeoLocation=function(a){var c=this.location;if(this.browserSupportFlag===true){l.console.log(this.posErrorMsg);l.console.log(a.message||"Geolocation service failed.")}else{l.console.log(this.geolocationErrorMsg);
l.console.log(a.message||"Your browser doesn't support geolocation.")}this.map.setCenter(c)};d.creator.prototype.initializeWaypoints=function(){var a=this,c=this.$waypoints.find("tr");this.wayPointId=c.length;c.each(function(){var b=j(this),e=b.find('input[name="waypoint"]');b=parseInt(b.find('button[name="waypointremove"]').attr("data-woald-id"),10);a.waypointsAdd(e,b)});this.setWaypointFields()};d.creator.prototype.setWaypointFields=function(){var a,c=[],b=[];this.$waypoints.find("tr").each(function(){a=
j(this).find('input[type="hidden"]');a.each(function(){c.push(this.name)});if(c.length>0){b.push(c.join(","));c.length=0}});this.$waypointFieldNames.val(b.join(";"))};d.creator.prototype.waypointsAdd=function(a,c){var b,e;if(!a){c=++this.wayPointId;this.$waypoints.append(this.getWaypointsHtml(c));a=this.$waypoints.find('input[data-woald-id="'+c+'"]')}a.on("paste",this.autocompleteOnPasteDelegate);this.$contextMenu.append(this.getWaypointContextMenu(c));this.$contextMenu.menu("refresh");this.autocompleteWaypoint(a,
c);b=this.$waypoints.find('button[name="waypointremove"]');e=this.$waypoints.find("tr");b.off();e.off();if(!this.waypointsRemoveDelegate)this.waypointsRemoveDelegate=d.createDelegate(this,this.waypointsRemoveHandler);b.on("click",this.waypointsRemoveDelegate);this.setWaypointFields()};d.creator.prototype.waypointsAddHandler=function(){this.$waypoints.find('input[name="waypoint"]').length<23&&this.waypointsAdd()};d.creator.prototype.findObject=function(a,c){var b=null,e;j.each(a,function(g,h){if(h.id===
c){b=h.obj;e=g;return false}});return{result:b,i:e}};d.creator.prototype.waypointsRemoveHandler=function(a){a=j(a.currentTarget).closest("tr");var c=a.find('input[name="waypoint"]'),b=a.find('button[name="waypointsearch"]'),e=a.find('button[name="waypointremove"]'),g=parseInt(e.data("woaldId"),10),h=this.findObject(this.autocompletesWaypoint,g),k=this.findObject(this.markersWaypoint,g),i=this.findObject(this.infoWindowsWaypoint,g);g=this.$contextMenu.find('a[data-woald-waypoint-id="'+g+'"]').parent();
this.isOpen(i.result)&&i.result.close(this.map,k.result);k.result.setMap(null);f.maps.event.clearListeners(h.result,"place_changed");f.maps.event.clearListeners(k.result,"click");c.off();this.autocompletesWaypoint.splice(h.i,1);this.markersWaypoint.splice(k.i,1);this.infoWindowsWaypoint.splice(i.i,1);a.off();e.off();b.off();a.remove();g.remove();this.$contextMenu.menu("refresh");this.setWaypointFields()};d.creator.prototype.autocompleteWaypoint=function(a,c){var b=new f.maps.places.Autocomplete(a[0]),
e,g,h,k,i=a.parent().find('button[name="waypointsearch"]'),m=this.$contextMenu.find('a[data-woald-waypoint-id="'+c+'"]');b.bindTo("bounds",this.map);b.setTypes(["geocode"]);if(!this.autocompletesWaypoint)this.autocompletesWaypoint=[];this.autocompletesWaypoint.push({id:c,obj:b});e=new f.maps.InfoWindow;if(!this.infoWindowsWaypoint)this.infoWindowsWaypoint=[];this.infoWindowsWaypoint.push({id:c,obj:e});g=new f.maps.Marker({map:this.map,anchorPoint:new f.maps.Point(0,-29)});if(!this.markersWaypoint)this.markersWaypoint=
[];this.markersWaypoint.push({id:c,obj:g});h=d.createCallback(this.toggleInfoWindowHandler,this,{infoWindow:e,marker:g});f.maps.event.addListener(g,"click",h);h=d.createCallback(this.autocomplete,this,[b,e,g,a]);k=d.createCallback(this.autocompleteSearchWaypointHandler,this,[b,e,g,a]);e=d.createCallback(this.contextMenuItemClickHandler,this,{infoWindow:e,marker:g,elem:a});f.maps.event.addListener(b,"place_changed",h);i.on("click",k);m.on("click",e)};d.creator.prototype.autocompleteSearchWaypointHandler=
function(a,c){var b=c[1],e=c[2],g=c[3],h=g.val();h&&this.geocodeRequest(h,{infoWindow:b,marker:e,elem:g})};d.creator.prototype.getWaypointsHtml=function(a){return"<tr><td>#"+a+'&nbsp;<input type="hidden" name="waypointAddress'+a+'"/><input type="hidden" name="waypointLat'+a+'"/><input type="hidden" name="waypointLng'+a+'"/><input type="text" data-parsley-errors-container=".waypoint'+a+'-error-container" class="form-control" placeholder="Add a stop on the way" name="waypoint" data-woald-id="'+a+'"data-woald-address="waypointAddress'+
a+'"data-woald-lat="waypointLat'+a+'"data-woald-lng="waypointLng'+a+'"/><button type="button" class="button button-primary button-search" name="waypointsearch"><i class="fa fa-search"></i></button><button type="button" title="Remove this stop" class="button button-primary" name="waypointremove" data-woald-id="'+a+'"><i class="fa fa-minus"></i></button><div class="waypoint'+a+'-error-container"></div></td></tr>'};d.creator.prototype.getWaypointContextMenu=function(a){return'<li><a href="#" data-woald-menu="3" data-woald-waypoint-id="'+
a+'"><span class="badge">#'+a+" - </span>"+this.waypointContextMenuLabel+"</a></li>"};d.creator.prototype.getContextMenu=function(){var a='<ul class="woald-creator-contextmenu hide">',c=parseInt(this.$contextMenuType.val(),10);if(c===0)a+='<li><a href="#" data-woald-menu="0">'+this.addressContextMenuLabel+"</a></li>";if([1,2].indexOf(c)!==-1)a+='<li><a href="#" data-woald-menu="4">'+this.newPlaceContextMenuLabel+"</a></li>";a+="</ul>";return a};d.creator.prototype.unloadHandler=function(){var a;f.maps.event.clearListeners(l,
"load");f.maps.event.clearListeners(l,"unload");if(this.autocompletes){for(a in this.autocompletes)f.maps.event.clearListeners(this.autocompletes[a],"place_changed");this.autocompletes.length=0}if(this.markers){for(a in this.markers)f.maps.event.clearListeners(this.markers[a],"click");this.markers.length=0}delete this.geocodeCallbackDelegate;delete this.getCurrentPositionDelegate;delete this.handleNoGeoLocationDelegate;delete this.unloadDelegate}})(window,document,google,Woald,window.jQuery,window.accounting);
